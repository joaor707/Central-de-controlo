<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <title>Painel Interativo Portugal e Sismos Mundiais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { background:#f0f4ff; font-family:sans-serif; }
        #map { height: 550px; width: 100%; border-radius:12px; }
        .painel-legenda { margin-top:20px; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 12px rgba(0,24,64,0.06);}
        .painel-legenda h3 {margin-top:0;}
        .painel-legenda .item {margin-bottom:10px;}
        .atualizacao {margin-top:12px; font-size:0.95em; color:#333;}
    </style>
</head>
<body>
    <h2>Painel Interativo - Portugal & Sismos Mundiais</h2>
    <div id="map"></div>
    <div class="painel-legenda">
        <h3>Legenda</h3>
        <div class="item"><span style="color:#c0392b;">●</span> Incêndio ativo (fogos.pt)</div>
        <div class="item"><span style="color:#2980b9;">●</span> Tempestade (IPMA)</div>
        <div class="item"><span style="color:#8e44ad;">●</span> Sismo Portugal (IPMA)</div>
        <div class="item"><span style="color:#e67e22;">●</span> Sismo mundial (USGS, Mag ≥ 5)</div>
    </div>
    <div class="atualizacao" id="ultimaAtualizacao"></div>
    
    <!-- Container for monitoring panel -->
    <div class="container"></div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    var map = L.map('map').setView([39.5, -8], 2.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    function setAtualizacao() {
        document.getElementById("ultimaAtualizacao").textContent = "Última atualização: " + new Date().toLocaleString("pt-PT");
    }

    // Sismos Portugal últimos 24h (IPMA)
    async function carregarSismosPT() {
        try {
            const res = await fetch('https://www.ipma.pt/resources.www/geofisica/sismicidade/catalogo_sismico.json');
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            
            const data = await res.json();
            
            if (!Array.isArray(data)) {
                throw new Error('Formato de dados inválido');
            }
            
            const hoje = new Date();
            const sismos24h = data.filter(sismo => {
                const sismoData = new Date(sismo.data);
                return (hoje - sismoData) < 1000 * 60 * 60 * 24;
            });
            
            if (sismos24h.length === 0) {
                // Adicionar marcador de placeholder
                var sismoIcon = L.divIcon({className:'', html:'<span style="color:#8e44ad;font-size:2em;">●</span>'});
                L.marker([38.7, -9.1], {icon:sismoIcon}).addTo(map)
                    .bindPopup("<b>Sismos Portugal (exemplo)</b><br>Sem sismos registados nas últimas 24h");
            } else {
                sismos24h.forEach(sismo => {
                    var sismoIcon = L.divIcon({className:'', html:'<span style="color:#8e44ad;font-size:2em;">●</span>'});
                    if (sismo.latitude && sismo.longitude) {
                        L.marker([sismo.latitude, sismo.longitude], {icon:sismoIcon}).addTo(map)
                            .bindPopup(`<b>Sismo Portugal</b><br>Local: ${sismo.local || "Desconhecido"}<br>Data: ${sismo.data}<br>Mag: ${sismo.magnitude || ""}`);
                    }
                });
            }
        } catch (e) {
            console.log("Erro ao buscar sismos IPMA:", e);
            // Adicionar marcador de erro
            var sismoIcon = L.divIcon({className:'', html:'<span style="color:#8e44ad;font-size:2em;">●</span>'});
            L.marker([38.7, -9.1], {icon:sismoIcon}).addTo(map)
                .bindPopup("<b>Sismos Portugal (erro)</b><br>Erro ao carregar dados do IPMA");
        }
    }
    carregarSismosPT();

    // Sismos Mundiais (USGS, magnitude >= 5, últimos 24h)
    async function carregarSismosMundo() {
        try {
            // USGS Earthquake Feed: últimos 24h, magnitude >= 5
            const url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/5.0_day.geojson";
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            
            const data = await res.json();
            
            if (!data.features || !Array.isArray(data.features)) {
                throw new Error('Formato de dados inválido');
            }
            
            if (data.features.length === 0) {
                // Adicionar marcador de placeholder
                var sismoIcon = L.divIcon({className:'', html:'<span style="color:#e67e22;font-size:2em;">●</span>'});
                L.marker([35.0, 25.0], {icon:sismoIcon}).addTo(map)
                    .bindPopup("<b>Sismos Mundiais (exemplo)</b><br>Sem sismos ≥ Mag 5.0 nas últimas 24h");
            } else {
                data.features.forEach(eq => {
                    const mag = eq.properties.mag;
                    const lugar = eq.properties.place;
                    const tempo = new Date(eq.properties.time).toLocaleString("pt-PT");
                    const coords = eq.geometry.coordinates; // [lng, lat, depth]
                    var sismoIcon = L.divIcon({className:'', html:'<span style="color:#e67e22;font-size:2em;">●</span>'});
                    L.marker([coords[1], coords[0]], {icon:sismoIcon}).addTo(map)
                        .bindPopup(`<b>Sismo Mundial</b><br>Local: ${lugar}<br>Data: ${tempo}<br>Mag: ${mag}`);
                });
            }
        } catch (e) {
            console.log("Erro ao buscar sismos USGS:", e);
            // Adicionar marcador de erro
            var sismoIcon = L.divIcon({className:'', html:'<span style="color:#e67e22;font-size:2em;">●</span>'});
            L.marker([35.0, 25.0], {icon:sismoIcon}).addTo(map)
                .bindPopup("<b>Sismos Mundiais (erro)</b><br>Erro ao carregar dados do USGS");
        }
    }
    carregarSismosMundo();

    // Tempestades (IPMA, exemplo Lisboa)
    async function carregarTempestades() {
        try {
            const res = await fetch('https://api.ipma.pt/open-data/forecast/meteorology/cities/daily/1110600.json');
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            
            const data = await res.json();
            
            if (!data.data || !Array.isArray(data.data)) {
                throw new Error('Formato de dados inválido');
            }
            
            const hojeStr = new Date().toISOString().slice(0, 10);
            const today = data.data.find(d => d.forecastDate === hojeStr);
            
            if (!today) {
                // Adicionar marcador de placeholder
                var tempIcon = L.divIcon({className: '', html:'<span style="color:#2980b9;font-size:2em;">●</span>'});
                L.marker([38.7, -9.1], {icon: tempIcon}).addTo(map)
                    .bindPopup("<b>Tempestades (exemplo)</b><br>Sem dados meteorológicos disponíveis para hoje");
            } else if (today.precipitaProb > 70 || today.windSpeed > 40) {
                var tempIcon = L.divIcon({className: '', html:'<span style="color:#2980b9;font-size:2em;">●</span>'});
                L.marker([38.7, -9.1], {icon: tempIcon}).addTo(map)
                    .bindPopup(`<b>Tempestade</b><br>Lisboa<br>Precipitação: ${today.precipitaProb}%<br>Vento: ${today.windSpeed} km/h`);
            } else {
                // Condições normais - adicionar marcador informativo
                var tempIcon = L.divIcon({className: '', html:'<span style="color:#2980b9;font-size:1.5em;">○</span>'});
                L.marker([38.7, -9.1], {icon: tempIcon}).addTo(map)
                    .bindPopup(`<b>Meteorologia</b><br>Lisboa - Condições normais<br>Precipitação: ${today.precipitaProb}%<br>Vento: ${today.windSpeed} km/h`);
            }
        } catch (e) {
            console.log("Erro ao buscar tempestades IPMA:", e);
            // Adicionar marcador de erro
            var tempIcon = L.divIcon({className: '', html:'<span style="color:#2980b9;font-size:2em;">●</span>'});
            L.marker([38.7, -9.1], {icon: tempIcon}).addTo(map)
                .bindPopup("<b>Tempestades (erro)</b><br>Erro ao carregar dados meteorológicos");
        }
    }
    carregarTempestades();

    // Fogos.pt - scraping público do site via proxy (allorigins.win)
    async function carregarIncendiosFogos() {
        try {
            const url = "https://api.allorigins.win/get?url=" + encodeURIComponent("https://fogos.pt/");
            const res = await fetch(url);
            const data = await res.json();
            const html = data.contents;
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;
            const cards = tempDiv.querySelectorAll('.fire-card');
            let count = 0;

            cards.forEach(card => {
                const titulo = card.querySelector('.fire-title')?.textContent?.trim();
                const local = card.querySelector('.fire-location')?.textContent?.trim();
                const mapLink = card.querySelector('a[href*="google.com/maps"]')?.getAttribute("href");
                let latlng = null;
                if (mapLink) {
                    const matches = mapLink.match(/([+-]?\d+\.\d+),([+-]?\d+\.\d+)/);
                    if (matches) latlng = [parseFloat(matches[1]), parseFloat(matches[2])];
                }
                var incendioIcon = L.divIcon({className: '', html:'<span style="color:#c0392b;font-size:2em;">●</span>'});
                if (latlng) {
                    L.marker(latlng, {icon: incendioIcon}).addTo(map)
                        .bindPopup(`<b>Incêndio</b><br>${titulo || ""}<br>${local || ""}`);
                    count++;
                }
            });

            if (count === 0) {
                var incendioIcon = L.divIcon({className: '', html:'<span style="color:#c0392b;font-size:2em;">●</span>'});
                L.marker([40.2, -8.4], {icon: incendioIcon}).addTo(map)
                    .bindPopup("<b>Incêndio ativo (exemplo)</b><br>Consulte fogos.pt para detalhes ao vivo.");
            }
        } catch (e) {
            var incendioIcon = L.divIcon({className: '', html:'<span style="color:#c0392b;font-size:2em;">●</span>'});
            L.marker([40.2, -8.4], {icon: incendioIcon}).addTo(map)
                .bindPopup("<b>Incêndio ativo (exemplo)</b><br>Consulte fogos.pt para detalhes ao vivo.");
            console.log("Erro ao buscar/incendios fogos.pt", e);
        }
    }
    carregarIncendiosFogos();

    setAtualizacao();
    </script>
    
    <!-- Include monitoring panel -->
    <script src="painel.js"></script>
</body>
</html>
